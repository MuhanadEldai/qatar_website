document.addEventListener('DOMContentLoaded', function() {
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcbtFN83XrghGeYu51tmYql2ldZelFrdwhsMbv-tkCd56SPZ8bKETIm4JfddB-JTc/exec';
    
    let currentPage = 1;
    let isLoading = false;
    let hasMoreReviews = true;
    let allReviews = []; 
    let currentSlide = 0; 
    let totalSlides = 0; 

    // Initialize
    if (typeof AOS !== 'undefined') AOS.init({ duration: 800, once: true });
    initBookingForm();
    loadReviews(); 
    loadGallery();
    setupStarRating();

    // ============================================
    // REVIEWS & VIEW-PAGER FIXES
    // ============================================
    function loadReviews(page = 1, append = false) {
        if (isLoading) return;
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        isLoading = true;
        if (!append) container.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-warning"></div></div>`;
        
        fetch(`${GOOGLE_SCRIPT_URL}?page=${page}&limit=3&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.reviews) {
                    allReviews = append ? [...allReviews, ...data.reviews] : data.reviews;
                    renderReviewSlides();
                    hasMoreReviews = data.pagination?.hasMore || false;
                    currentPage = page;
                } else if (!append) showNoReviews();
            })
            .catch(() => { if (!append) showNoReviews(); })
            .finally(() => {
                isLoading = false;
                updateLoadMoreButton();
            });
    }

    function renderReviewSlides() {
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        container.innerHTML = `
            <div class="viewpager-container">
                <div class="viewpager-slides"></div>
                <div class="viewpager-controls">
                    <button class="viewpager-nav prev"><i class="fas fa-chevron-left"></i></button>
                    <div class="viewpager-dots"></div>
                    <button class="viewpager-nav next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        `;

        const slidesContainer = container.querySelector('.viewpager-slides');
        for (let i = 0; i < allReviews.length; i += 3) {
            const slide = document.createElement('div');
            slide.className = 'viewpager-slide';
            
            // Create cards for this slide
            const slideReviews = allReviews.slice(i, i + 3);
            slideReviews.forEach((review, idx) => {
                slide.innerHTML += createReviewCard(review, i + idx);
            });
            slidesContainer.appendChild(slide);
        }
        totalSlides = slidesContainer.children.length;
        setupViewPagerControls(container);
    }

    function createReviewCard(review, index) {
        const rating = parseInt(review.rating) || 5;
        const fullText = review.review || '';
        const charLimit = 120;
        const isLong = fullText.length > charLimit;
        let content = isLong ? 
            `${fullText.substring(0, charLimit)}<span class="more-text" id="more-${index}">${fullText.substring(charLimit)}</span> <a href="javascript:void(0)" class="show-more-link" onclick="toggleReview(${index})">Show more</a>` : 
            fullText;

        return `
            <div class="review-card-wrapper">
                <div class="card border-0 shadow-sm review-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="review-initials">${getInitials(review.name)}</div>
                            <div class="ms-3">
                                <h6 class="mb-0 review-name">${review.name || 'Guest'}</h6>
                                <div class="review-stars">${'<i class="fas fa-star"></i>'.repeat(rating)}</div>
                            </div>
                        </div>
                        <p class="review-text mb-0">"${content}"</p>
                    </div>
                </div>
            </div>`;
    }

    // ============================================
    // BOOKING FORM TIME SLOT FIX
    // ============================================
    function initBookingForm() {
        // Fix time slot selection
        const timeSlots = document.querySelectorAll('.time-slot');
        timeSlots.forEach(slot => {
            slot.addEventListener('click', function() {
                // Remove active class from all slots
                timeSlots.forEach(s => s.classList.remove('active'));
                // Add active class to clicked slot
                this.classList.add('active');
                
                // Update summary
                const timeLabel = this.querySelector('.time-label').textContent;
                const timeRange = this.querySelector('.time-range').textContent;
                updateBookingSummary('time', `${timeLabel} (${timeRange})`);
            });
        });

        // Update date in summary
        const dateInput = document.querySelector('input[type="date"]');
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                const date = new Date(this.value);
                const formattedDate = date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                updateBookingSummary('date', formattedDate);
            });
        }

        // Update count inputs
        document.querySelectorAll('.input-group button').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.closest('.input-group').querySelector('input').id.includes('adults') ? 'adults' : 'children';
                const change = this.textContent === '+' ? 1 : -1;
                adjustCount(type, change);
            });
        });

        // Form submission
        const bookingForm = document.getElementById('bookingForm');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitBooking();
            });
        }
    }

    function adjustCount(type, change) {
        const input = document.getElementById(type + 'Count');
        let value = parseInt(input.value) + change;
        if (type === 'adults') value = Math.max(1, value);
        else value = Math.max(0, value);
        input.value = value;
        updateBookingSummary(type, value);
    }

    function updateBookingSummary(type, value) {
        const summaryMap = {
            'adults': 'Adults:',
            'children': 'Children:',
            'date': 'Date:',
            'time': 'Time:'
        };
        
        const summaries = document.querySelectorAll('.bg-dark .d-flex.justify-content-between span');
        summaries.forEach(summary => {
            const text = summary.textContent.trim();
            if (text.includes(summaryMap[type])) {
                const valueSpan = summary.nextElementSibling;
                if (valueSpan) {
                    valueSpan.textContent = value;
                }
            }
        });
    }

    function submitBooking() {
        const form = document.getElementById('bookingForm');
        if (!form) return;
        
        // Get form values
        const name = form.querySelector('input[type="text"]').value;
        const phone = form.querySelector('input[type="tel"]').value;
        const email = form.querySelector('input[type="email"]').value;
        const date = form.querySelector('input[type="date"]').value;
        const location = form.querySelectorAll('input[type="text"]')[1].value;
        const adults = document.getElementById('adultsCount').value;
        const children = document.getElementById('childrenCount').value;
        const requests = form.querySelector('textarea').value;
        
        // Get selected time slot
        const activeSlot = document.querySelector('.time-slot.active');
        const time = activeSlot ? activeSlot.querySelector('.time-range').textContent : 'Morning (8:30-12:30)';
        
        // Create WhatsApp message
        const message = `ðŸ“‹ *New Booking Request* ðŸ“‹
        
ðŸ‘¤ *Name:* ${name}
ðŸ“ž *Phone:* ${phone}
ðŸ“§ *Email:* ${email}
ðŸ“… *Date:* ${date}
â° *Time:* ${time}
ðŸ“ *Pickup:* ${location}
ðŸ‘¥ *Adults:* ${adults}
ðŸ‘¶ *Children:* ${children}
ðŸ’­ *Requests:* ${requests || 'None'}
        
Please confirm availability and pricing.`;
        
        // Open WhatsApp
        const whatsappUrl = `https://wa.me/97466955259?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        // Show success modal
        const modal = new bootstrap.Modal(document.getElementById('successModal'));
        modal.show();
    }

    // ============================================
    // STAR RATING FIX (Mobile Compatible)
    // ============================================
    function setupStarRating() {
        const stars = document.querySelectorAll('.rating-input .stars i');
        const ratingInput = document.getElementById('reviewRating');
        
        if (!stars.length || !ratingInput) return;
        
        // Make stars clickable on mobile
        stars.forEach(star => {
            // Remove any existing listeners
            star.replaceWith(star.cloneNode(true));
        });
        
        const newStars = document.querySelectorAll('.rating-input .stars i');
        let currentRating = parseInt(ratingInput.value) || 5;
        
        // Set initial rating
        updateStarDisplay(currentRating);
        
        newStars.forEach(star => {
            // Click event
            star.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                currentRating = value;
                ratingInput.value = value;
                updateStarDisplay(value);
            });
            
            // Touch events for mobile
            star.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const value = parseInt(this.getAttribute('data-value'));
                currentRating = value;
                ratingInput.value = value;
                updateStarDisplay(value);
            });
        });
        
        function updateStarDisplay(rating) {
            newStars.forEach((star, index) => {
                const starValue = index + 1;
                if (starValue <= rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'active');
                } else {
                    star.classList.remove('fas', 'active');
                    star.classList.add('far');
                }
            });
        }
    }

    // ============================================
    // GALLERY LOADER
    // ============================================
    function loadGallery() {
        const galleryGrid = document.getElementById('galleryGrid');
        if (!galleryGrid) return;
        
        const galleryItems = [
            { title: 'Dune Bashing', desc: 'Thrilling safari' },
            { title: 'Inland Sea', desc: 'Desert meets sea' },
            { title: 'Sand Boarding', desc: 'Surf the dunes' },
            { title: 'Sunset View', desc: 'Desert magic' }
        ];
        
        galleryGrid.innerHTML = galleryItems.map(item => `
            <div class="gallery-item">
                <img src="https://placehold.co/600x400/FFD700/333?text=${encodeURIComponent(item.title)}" 
                     alt="${item.title}" 
                     onerror="this.src='https://placehold.co/600x400?text=Image+Not+Found'">
                <div class="gallery-caption">
                    <h6>${item.title}</h6>
                    <p style="font-size:12px">${item.desc}</p>
                </div>
            </div>
        `).join('');
    }

    // ============================================
    // GLOBAL WINDOW FUNCTIONS
    // ============================================
    window.toggleReview = function(index) {
        const span = document.getElementById(`more-${index}`);
        const link = span ? span.nextElementSibling : null;
        
        if (span && link) {
            span.classList.toggle('show');
            link.textContent = span.classList.contains('show') ? 'Show less' : 'Show more';
        }
    };

    window.goToSlide = function(index) {
        if (index < 0 || index >= totalSlides) return;
        currentSlide = index;
        const slides = document.querySelector('.viewpager-slides');
        if (slides) {
            slides.style.transform = `translateX(-${index * 100}%)`;
        }
        updatePaginationUI();
    };

    function moveSlide(dir) {
        const newSlide = (currentSlide + dir + totalSlides) % totalSlides;
        window.goToSlide(newSlide);
    }

    function setupViewPagerControls(container) {
        const prevBtn = container.querySelector('.prev');
        const nextBtn = container.querySelector('.next');
        
        if (prevBtn) prevBtn.addEventListener('click', () => moveSlide(-1));
        if (nextBtn) nextBtn.addEventListener('click', () => moveSlide(1));
        
        updatePaginationUI();
        window.goToSlide(currentSlide);
    }

    function updatePaginationUI() {
        const dotsContainer = document.querySelector('.viewpager-dots');
        if (!dotsContainer) return;
        
        if (totalSlides > 5) {
            dotsContainer.innerHTML = `<span class="viewpager-counter">Page ${currentSlide + 1} / ${totalSlides}</span>`;
        } else {
            dotsContainer.innerHTML = Array.from({length: totalSlides}, (_, i) => 
                `<button class="viewpager-dot ${i === currentSlide ? 'active' : ''}" onclick="goToSlide(${i})"></button>`).join('');
        }
    }

    function updateLoadMoreButton() {
        const btn = document.getElementById('loadMoreBtn');
        if (btn) btn.style.display = hasMoreReviews ? 'inline-block' : 'none';
    }

    function getInitials(name) { 
        return (name || 'G').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2); 
    }

    function showNoReviews() { 
        const container = document.getElementById('reviewsContainer');
        if (container) {
            container.innerHTML = '<p class="text-center py-4 text-muted">No reviews yet. Be the first to share your experience!</p>';
        }
    }

    // Initialize on load
    window.addEventListener('load', function() {
        // Re-initialize star rating after all content is loaded
        setTimeout(setupStarRating, 100);
    });
});
