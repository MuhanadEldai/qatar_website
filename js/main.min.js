document.addEventListener('DOMContentLoaded', function() {
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcbtFN83XrghGeYu51tmYql2ldZelFrdwhsMbv-tkCd56SPZ8bKETIm4JfddB-JTc/exec';
    
    let currentPage = 1;
    let isLoading = false;
    let hasMoreReviews = true;
    let allReviews = []; 
    let currentSlide = 0; 
    let totalSlides = 0; 
    let autoSlideInterval; 

    // 1. Initialize Booking and UI
    if (typeof AOS !== 'undefined') AOS.init({ duration: 800, once: true });
    initBookingForm();
    loadReviews(); 
    loadGallery(); // Added fixed gallery loader
    setupStarRating();

    // ============================================
    // REVIEWS & VIEW-PAGER (Padding & Zoom Fix)
    // ============================================
    function loadReviews(page = 1, append = false) {
        if (isLoading) return;
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        isLoading = true;
        if (!append) container.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-warning"></div></div>`;
        
        fetch(`${GOOGLE_SCRIPT_URL}?page=${page}&limit=3&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.reviews) {
                    allReviews = append ? [...allReviews, ...data.reviews] : data.reviews;
                    renderReviewSlides();
                    hasMoreReviews = data.pagination?.hasMore || false;
                    currentPage = page;
                } else if (!append) showNoReviews();
            })
            .catch(() => { if (!append) showNoReviews(); })
            .finally(() => {
                isLoading = false;
                updateLoadMoreButton();
            });
    }

    function renderReviewSlides() {
        const container = document.getElementById('reviewsContainer');
        container.innerHTML = `
            <div class="viewpager-container">
                <div class="viewpager-slides"></div>
                <div class="viewpager-controls" style="margin-top: 10px;">
                    <button class="viewpager-nav prev"><i class="fas fa-chevron-left"></i></button>
                    <div class="viewpager-dots"></div>
                    <button class="viewpager-nav next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        `;

        const slidesContainer = container.querySelector('.viewpager-slides');
        for (let i = 0; i < allReviews.length; i += 3) {
            const slide = document.createElement('div');
            slide.className = 'viewpager-slide';
            allReviews.slice(i, i + 3).forEach((review, idx) => {
                slide.innerHTML += createReviewCard(review, i + idx);
            });
            slidesContainer.appendChild(slide);
        }
        totalSlides = slidesContainer.children.length;
        setupViewPagerControls(container);
    }

    function createReviewCard(review, index) {
        const rating = parseInt(review.rating) || 5;
        const fullText = review.review || '';
        const charLimit = 80;
        let content = fullText.length > charLimit ? 
            `${fullText.substring(0, charLimit)}<span class="more-text" id="more-${index}">${fullText.substring(charLimit)}</span> <a href="javascript:void(0)" class="show-more-link" onclick="toggleReview(this, ${index})">Show more</a>` : 
            fullText;

        return `
            <div style="flex: 1; max-width: 350px; min-width: 250px;">
                <div class="card border-0 shadow-sm review-card-small">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-2" style="width:30px; height:30px; font-size:11px; font-weight:bold">${getInitials(review.name)}</div>
                            <div>
                                <h6 class="mb-0" style="font-size:13px">${review.name || 'Guest'}</h6>
                                <div class="text-warning" style="font-size:10px">${'<i class="fas fa-star"></i>'.repeat(rating)}</div>
                            </div>
                        </div>
                        <p class="mb-1" style="font-size:12px; line-height:1.4">"${content}"</p>
                    </div>
                </div>
            </div>`;
    }

    // ============================================
    // GALLERY LOADER (Fixing Path and Visibility)
    // ============================================
    function loadGallery() {
        const galleryGrid = document.getElementById('galleryGrid');
        if (!galleryGrid) return;
        
        const galleryItems = [
            { title: 'Dune Bashing', desc: 'Thrilling safari' },
            { title: 'Inland Sea', desc: 'Desert meets sea' },
            { title: 'Sand Boarding', desc: 'Surf the dunes' },
            { title: 'Sunset View', desc: 'Desert magic' }
        ];
        
        galleryGrid.innerHTML = galleryItems.map(item => `
            <div class="gallery-item">
                <img src="https://placehold.co/600x400/FFD700/333?text=${encodeURIComponent(item.title)}" 
                     alt="${item.title}" 
                     onerror="this.src='https://placehold.co/600x400?text=Image+Not+Found'">
                <div class="gallery-caption">
                    <h6>${item.title}</h6>
                    <p style="font-size:12px">${item.desc}</p>
                </div>
            </div>
        `).join('');
    }

    // ============================================
    // GLOBAL WINDOW FUNCTIONS
    // ============================================
    window.toggleReview = function(btn, index) {
        const span = document.getElementById(`more-${index}`);
        span.classList.toggle('show');
        btn.innerText = span.classList.contains('show') ? 'Show less' : 'Show more';
    };

    window.goToSlide = function(index) {
        currentSlide = index;
        const slides = document.querySelector('.viewpager-slides');
        if (slides) slides.style.transform = `translateX(-${index * 100}%)`;
        updatePaginationUI();
    };

    function moveSlide(dir) {
        currentSlide = (currentSlide + dir + totalSlides) % totalSlides;
        window.goToSlide(currentSlide);
    }

    function setupViewPagerControls(container) {
        container.querySelector('.prev').onclick = () => moveSlide(-1);
        container.querySelector('.next').onclick = () => moveSlide(1);
        updatePaginationUI();
        window.goToSlide(currentSlide);
    }

    function updatePaginationUI() {
        const dotsContainer = document.querySelector('.viewpager-dots');
        if (!dotsContainer) return;
        if (totalSlides > 5) {
            dotsContainer.innerHTML = `<span style="font-size:12px; font-weight:bold">Page ${currentSlide + 1} / ${totalSlides}</span>`;
        } else {
            dotsContainer.innerHTML = Array.from({length: totalSlides}, (_, i) => 
                `<button class="viewpager-dot ${i === currentSlide ? 'active' : ''}" onclick="goToSlide(${i})"></button>`).join('');
        }
    }

    function updateLoadMoreButton() {
        const btn = document.getElementById('loadMoreBtn');
        if (btn) btn.style.display = hasMoreReviews ? 'inline-block' : 'none';
    }

    function getInitials(name) { return (name || 'G').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2); }
    function initBookingForm() { /* Existing booking logic */ }
    function setupStarRating() { /* Existing star logic */ }
    function showNoReviews() { document.getElementById('reviewsContainer').innerHTML = '<p>No reviews yet.</p>'; }
});
