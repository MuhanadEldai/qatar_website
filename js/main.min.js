// MOVE THIS FUNCTION OUTSIDE THE DOMContentLoaded EVENT
function submitBooking() {
    console.log('submitBooking function called'); // Debug line
    
    const form = document.getElementById('bookingForm');
    if (!form) {
        console.error('Form not found');
        return false;
    }

    // Get form data
    const name = form.querySelector('input[placeholder*="Name"]')?.value || '';
    const phone = form.querySelector('input[type="tel"]')?.value || '';
    const email = form.querySelector('input[type="email"]')?.value || '';
    const date = form.querySelector('input[type="date"]')?.value || '';
    const location = form.querySelector('input[placeholder*="hotel"], input[placeholder*="location"]')?.value || '';
    const adults = document.getElementById('adultsCount')?.value || '1';
    const children = document.getElementById('childrenCount')?.value || '0';
    const requests = form.querySelector('textarea')?.value || '';

    // Get selected time
    const activeSlot = document.querySelector('.time-slot.active');
    let timeLabel = 'Morning';
    let timeRange = '8:30-12:30';
    
    if (activeSlot) {
        timeLabel = activeSlot.querySelector('.time-label')?.textContent || 'Morning';
        timeRange = activeSlot.querySelector('.time-range')?.textContent || '8:30-12:30';
    }

    // Create WhatsApp message
    const message = `üìã *NEW BOOKING REQUEST* üìã%0A%0A` +
        `üë§ *Name:* ${name}%0A` +
        `üìû *Phone:* ${phone}%0A` +
        `üìß *Email:* ${email}%0A` +
        `üìÖ *Date:* ${date}%0A` +
        `‚è∞ *Time:* ${timeLabel} (${timeRange})%0A` +
        `üìç *Pickup:* ${location}%0A` +
        `üë• *Adults:* ${adults}%0A` +
        `üë∂ *Children:* ${children}%0A` +
        `üí≠ *Requests:* ${requests || 'None'}%0A%0A` +
        `*Please confirm availability.*`;

    const whatsappUrl = `https://wa.me/97466955259?text=${message}`;
    
    console.log('WhatsApp URL:', whatsappUrl); // Debug line
    
    // Open WhatsApp
    window.open(whatsappUrl, '_blank');
    
    // Show success modal
    const modalElement = document.getElementById('successModal');
    if (modalElement && typeof bootstrap !== 'undefined') {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
    
    // Prevent form from submitting normally
    return false;
}


document.addEventListener('DOMContentLoaded', function() {
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcbtFN83XrghGeYu51tmYql2ldZelFrdwhsMbv-tkCd56SPZ8bKETIm4JfddB-JTc/exec';
    
    let currentPage = 1;
    let isLoading = false;
    let hasMoreReviews = true;
    let allReviews = []; 
    let currentSlide = 0; 
    let totalSlides = 0; 

    // Initialize
    if (typeof AOS !== 'undefined') AOS.init({ duration: 800, once: true });
    
    initBookingForm();
    loadReviews(); 
    loadGallery();
    setupStarRating();
    setupReviewForm(); // <--- ADDED THIS INITIALIZER

    // ============================================
    // REVIEW SUBMISSION & HIDING FORM
    // ============================================
    function setupReviewForm() {
        const form = document.getElementById('reviewForm');
        if (!form) return;

        // 1. Hide form if they already submitted in this browser session
        if (localStorage.getItem('userSubmittedReview') === 'true') {
            replaceFormWithSuccess();
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const name = document.getElementById('reviewName').value;
            const rating = document.getElementById('reviewRating').value;
            const review = document.getElementById('reviewText').value;

            // UI Feedback
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';

            // Construct the URL with parameters for the Google Script
            const url = `${GOOGLE_SCRIPT_URL}?name=${encodeURIComponent(name)}&rating=${rating}&review=${encodeURIComponent(review)}&t=${Date.now()}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // 2. Success logic: Save state, hide form, refresh reviews
                        localStorage.setItem('userSubmittedReview', 'true');
                        replaceFormWithSuccess();
                        loadReviews(1, false); // Reload first page of reviews to show new one
                    } else {
                        alert('Submission failed. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Review';
                    }
                })
                .catch(err => {
                    console.error('Error submitting review:', err);
                    alert('An error occurred. Please check your connection.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Review';
                });
        });
    }

    function replaceFormWithSuccess() {
        const formElement = document.getElementById('reviewForm');
        if (formElement) {
            // Replace form content with a success message
            formElement.innerHTML = `
                <div class="text-center py-5 animate__animated animate__fadeIn">
                    <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                    <h4 class="fw-bold">Review Submitted!</h4>
                    <p class="text-muted">Thank you for sharing your experience with Golden Sky Tourism.</p>
                </div>
            `;
        }
    }

    // ============================================
    // REVIEWS & VIEW-PAGER FIXES
    // ============================================
    function loadReviews(page = 1, append = false) {
        if (isLoading) return;
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        isLoading = true;
        if (!append) container.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-warning"></div></div>`;
        
        fetch(`${GOOGLE_SCRIPT_URL}?page=${page}&limit=3&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.reviews) {
                    allReviews = append ? [...allReviews, ...data.reviews] : data.reviews;
                    renderReviewSlides();
                    hasMoreReviews = data.pagination?.hasMore || false;
                    currentPage = page;
                } else if (!append) showNoReviews();
            })
            .catch(() => { if (!append) showNoReviews(); })
            .finally(() => {
                isLoading = false;
            });
    }

    function renderReviewSlides() {
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        container.innerHTML = `
            <div class="viewpager-container">
                <div class="viewpager-slides"></div>
                <div class="viewpager-controls">
                    <button class="viewpager-nav prev"><i class="fas fa-chevron-left"></i></button>
                    <div class="viewpager-dots"></div>
                    <button class="viewpager-nav next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        `;

        const slidesContainer = container.querySelector('.viewpager-slides');
        for (let i = 0; i < allReviews.length; i += 3) {
            const slide = document.createElement('div');
            slide.className = 'viewpager-slide';
            const slideReviews = allReviews.slice(i, i + 3);
            slideReviews.forEach((review, idx) => {
                slide.innerHTML += createReviewCard(review, i + idx);
            });
            slidesContainer.appendChild(slide);
        }
        totalSlides = slidesContainer.children.length;
        setupViewPagerControls(container);
    }

    function createReviewCard(review, index) {
        const rating = parseInt(review.rating) || 5;
        const fullText = review.review || '';
        const charLimit = 120;
        const isLong = fullText.length > charLimit;
        let content = isLong ? 
            `${fullText.substring(0, charLimit)}<span class="more-text" id="more-${index}">${fullText.substring(charLimit)}</span> <a href="javascript:void(0)" class="show-more-link" onclick="toggleReview(${index})">Show more</a>` : 
            fullText;

        return `
            <div class="review-card-wrapper">
                <div class="card border-0 shadow-sm review-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="review-initials">${getInitials(review.name)}</div>
                            <div class="ms-3">
                                <h6 class="mb-0 review-name">${review.name || 'Guest'}</h6>
                                <div class="review-stars text-warning">${'<i class="fas fa-star"></i>'.repeat(rating)}</div>
                            </div>
                        </div>
                        <p class="review-text mb-0">"${content}"</p>
                    </div>
                </div>
            </div>`;
    }

    // ============================================
    // BOOKING FORM (WHATSAPP)
    // ============================================
    function initBookingForm() {
        const timeSlots = document.querySelectorAll('.time-slot');
        timeSlots.forEach(slot => {
            slot.addEventListener('click', function() {
                timeSlots.forEach(s => s.classList.remove('active'));
                this.classList.add('active');
                const timeLabel = this.querySelector('.time-label').textContent;
                const timeRange = this.querySelector('.time-range').textContent;
                updateBookingSummary('time', `${timeLabel} (${timeRange})`);
            });
        });

        const dateInput = document.querySelector('input[type="date"]');
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                const date = new Date(this.value);
                const formattedDate = date.toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });
                updateBookingSummary('date', formattedDate);
            });
        }

        const bookingForm = document.getElementById('bookingForm');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitBooking();
            });
        }
    }
    

    // ============================================
    // STAR RATING & UI HELPERS
    // ============================================
    function setupStarRating() {
        const stars = document.querySelectorAll('.rating-input .stars i');
        const ratingInput = document.getElementById('reviewRating');
        if (!stars.length || !ratingInput) return;

        stars.forEach(star => {
            star.addEventListener('click', function() {
                const val = this.getAttribute('data-value');
                ratingInput.value = val;
                stars.forEach(s => {
                    s.classList.toggle('fas', s.getAttribute('data-value') <= val);
                    s.classList.toggle('far', s.getAttribute('data-value') > val);
                    s.classList.toggle('active', s.getAttribute('data-value') <= val);
                });
            });
        });
    }


    
    function loadGallery() {
    const galleryGrid = document.getElementById('galleryGrid');
    if (!galleryGrid) return;

    const galleryItems = [
        { title: 'Falconry Experience', desc: 'Traditional Qatari culture', img: 'images/tour-photos/falcon.jpg' },
        { title: 'Desert Legend', desc: 'Our Land Cruiser fleet', img: 'land-cruiser.jpg' },
        { title: 'Group Safari', desc: 'Unforgettable memories', img: 'group-photo.jpg' },
        { title: 'Inland Sea', desc: 'Where desert meets the ocean', img: 'inland-sea.jpg' },
        { title: 'Sand Boarding', desc: 'Thrills on the dunes', img: 'sand-boarding.jpg' },
        { title: 'Sunset Magic', desc: 'Golden hour in the desert', img: 'sunset-view.jpg' }
    ];

    galleryGrid.innerHTML = galleryItems.map(item => `
        <div class="gallery-item" style="cursor: pointer;" onclick="openLightbox('${item.img}', '${item.title}', '${item.desc}')">
            <img src="assets/${item.img}" 
                 alt="${item.title}" 
                 loading="lazy"
                 onerror="this.onerror=null; this.src='https://placehold.co/600x400/FFD700/333?text=${encodeURIComponent(item.title)}'">
            <div class="gallery-caption">
                <h6 class="mb-0">${item.title}</h6>
                <p class="mb-0" style="font-size:11px; opacity:0.9">${item.desc}</p>
            </div>
        </div>
    `).join('');
}

// Lightbox function
function openLightbox(image, title, desc) {
    const lightbox = document.createElement('div');
    lightbox.id = 'lightbox';
    lightbox.innerHTML = `
        <div class="lightbox-content">
            <span class="close" onclick="closeLightbox()">√ó</span>
            <img src="assets/${image}" alt="${title}">
            <h2>${title}</h2>
            <p>${desc}</p>
        </div>
    `;
    document.body.appendChild(lightbox);
    document.body.style.overflow = 'hidden'; // Prevent background scroll
}

// Close lightbox function
function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    if (lightbox) {
        document.body.removeChild(lightbox);
        document.body.style.overflow = ''; // Restore background scroll
    }
}

    

    window.toggleReview = function(index) {
        const span = document.getElementById(`more-${index}`);
        const link = span ? span.nextElementSibling : null;
        if (span && link) {
            span.classList.toggle('show');
            link.textContent = span.classList.contains('show') ? 'Show less' : 'Show more';
        }
    };

    window.goToSlide = function(index) {
        currentSlide = index;
        const slides = document.querySelector('.viewpager-slides');
        if (slides) slides.style.transform = `translateX(-${index * 100}%)`;
        updatePaginationUI();
    };

    function setupViewPagerControls(container) {
        container.querySelector('.prev').onclick = () => { currentSlide = (currentSlide - 1 + totalSlides) % totalSlides; window.goToSlide(currentSlide); };
        container.querySelector('.next').onclick = () => { currentSlide = (currentSlide + 1) % totalSlides; window.goToSlide(currentSlide); };
        updatePaginationUI();
    }

  function updatePaginationUI() {
    const dotsContainer = document.querySelector('.viewpager-dots');
    if (!dotsContainer) return;

    // Always show "Page X of Y" instead of dots
    if (totalSlides > 0) {
        dotsContainer.innerHTML = `
            <span class="page-counter">
                Page <span class="current">${currentSlide + 1}</span> of <span class="total">${totalSlides}</span>
            </span>
        `;
    } else {
        dotsContainer.innerHTML = '';
    }
}

    function getInitials(name) { return (name || 'G').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2); }

});
