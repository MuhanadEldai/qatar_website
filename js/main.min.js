// Golden Sky Tourism - Optimized Version
document.addEventListener('DOMContentLoaded', function() {
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcbtFN83XrghGeYu51tmYql2ldZelFrdwhsMbv-tkCd56SPZ8bKETIm4JfddB-JTc/exec';
    
    // State management
    let currentPage = 1;
    let isLoading = false;
    let hasMoreReviews = true;
    let userSubmittedReview = localStorage.getItem('userSubmittedReview') === 'true';
    let allReviews = []; 
    let currentSlide = 0; 
    let totalSlides = 0; 
    let autoSlideInterval; 

    // ============================================
    // INITIALIZATION
    // ============================================
    if (typeof AOS !== 'undefined') {
        AOS.init({ duration: 800, once: true, offset: 100 });
    }

    initBookingForm();
    loadReviews(); // Load first batch
    setupReviewForm();
    setupStarRating();
    createLoadMoreButton();

    // ============================================
    // REVIEWS CORE ENGINE
    // ============================================

    function loadReviews(page = 1, append = false) {
        if (isLoading) return;
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        
        isLoading = true;
        if (!append) {
            container.innerHTML = `<div class="col-12 text-center"><div class="spinner-border text-warning" role="status"></div><p class="mt-3">Loading reviews...</p></div>`;
        }
        
        fetch(`${GOOGLE_SCRIPT_URL}?page=${page}&limit=3&t=${Date.now()}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.reviews) {
                    if (append) {
                        allReviews = [...allReviews, ...data.reviews];
                        renderReviewSlides(); // Re-render to handle 3-per-page logic
                    } else {
                        allReviews = data.reviews;
                        renderReviewSlides();
                    }
                    hasMoreReviews = data.pagination?.hasMore || false;
                    currentPage = page;
                } else if (!append) {
                    showNoReviews();
                }
            })
            .catch(() => { if (!append) showNoReviews(); })
            .finally(() => {
                isLoading = false;
                updateLoadMoreButton();
            });
    }

    function renderReviewSlides() {
        const container = document.getElementById('reviewsContainer');
        container.innerHTML = `
            <div class="viewpager-container">
                <div class="viewpager-slides"></div>
                <div class="viewpager-controls">
                    <button class="viewpager-nav prev"><i class="fas fa-chevron-left"></i></button>
                    <div class="viewpager-dots"></div>
                    <button class="viewpager-nav next"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        `;

        const slidesContainer = container.querySelector('.viewpager-slides');
        
        // Group allReviews into chunks of 3
        for (let i = 0; i < allReviews.length; i += 3) {
            const slide = document.createElement('div');
            slide.className = 'viewpager-slide';
            const chunk = allReviews.slice(i, i + 3);
            
            chunk.forEach((review, index) => {
                slide.innerHTML += createReviewCard(review, i + index);
            });
            slidesContainer.appendChild(slide);
        }

        totalSlides = slidesContainer.children.length;
        setupViewPagerControls(container);
    }

    function createReviewCard(review, index) {
        const name = review.name || 'Guest';
        const rating = parseInt(review.rating) || 5;
        const fullText = review.review || '';
        const charLimit = 85;

        let reviewContent = '';
        if (fullText.length > charLimit) {
            const visible = fullText.substring(0, charLimit);
            const hidden = fullText.substring(charLimit);
            reviewContent = `
                "${escapeHtml(visible)}<span class="more-text" id="more-${index}">${escapeHtml(hidden)}</span>"
                <a href="javascript:void(0)" class="show-more-link" onclick="toggleReview(this, ${index})">Show more</a>
            `;
        } else {
            reviewContent = `"${escapeHtml(fullText)}"`;
        }

        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<i class="${i <= rating ? 'fas' : 'far'} fa-star text-warning" style="font-size:10px"></i>`;
        }

        return `
            <div class="col-md-4 mb-2">
                <div class="card border-0 shadow-sm review-card-small">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-2" style="width:30px; height:30px; font-size:11px; font-weight:bold">
                                ${getInitials(name)}
                            </div>
                            <div>
                                <h6 class="mb-0" style="font-size:13px">${escapeHtml(name)}</h6>
                                <div>${stars}</div>
                            </div>
                        </div>
                        <p class="review-text mb-1" style="font-size:13px; line-height:1.4">${reviewContent}</p>
                        <div class="text-muted" style="font-size:10px">${review.date || 'Recently'}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ============================================
    // VIEWPAGER LOGIC (SAVES DOTS OVERFLOW)
    // ============================================

    function setupViewPagerControls(container) {
        const prevBtn = container.querySelector('.prev');
        const nextBtn = container.querySelector('.next');
        
        prevBtn.onclick = () => moveSlide(-1);
        nextBtn.onclick = () => moveSlide(1);

        updatePaginationUI();
        goToSlide(currentSlide);
        
        // Auto-slide
        if (autoSlideInterval) clearInterval(autoSlideInterval);
        autoSlideInterval = setInterval(() => moveSlide(1), 6000);
    }

    function moveSlide(direction) {
        let target = currentSlide + direction;
        if (target >= totalSlides) target = 0;
        if (target < 0) target = totalSlides - 1;
        goToSlide(target);
    }

    window.goToSlide = function(index) {
        currentSlide = index;
        const slides = document.querySelector('.viewpager-slides');
        if (slides) slides.style.transform = `translateX(-${index * 100}%)`;
        updatePaginationUI();
    };

    function updatePaginationUI() {
        const dotsContainer = document.querySelector('.viewpager-dots');
        if (!dotsContainer) return;

        // If many pages, switch to "Page X of Y"
        if (totalSlides > 5) {
            dotsContainer.innerHTML = `<span class="page-indicator" style="font-size: 12px; color: #666; font-weight: bold;">Page ${currentSlide + 1} / ${totalSlides}</span>`;
        } else {
            let dotsHtml = '';
            for (let i = 0; i < totalSlides; i++) {
                dotsHtml += `<button class="viewpager-dot ${i === currentSlide ? 'active' : ''}" onclick="goToSlide(${i})"></button>`;
            }
            dotsContainer.innerHTML = dotsHtml;
        }
    }

    // ============================================
    // UTILS & GLOBAL HELPERS
    // ============================================

    window.toggleReview = function(btn, index) {
        const span = document.getElementById(`more-${index}`);
        if (span.classList.contains('show')) {
            span.classList.remove('show');
            btn.innerText = 'Show more';
        } else {
            span.classList.add('show');
            btn.innerText = 'Show less';
        }
    };

    function updateLoadMoreButton() {
        const btn = document.getElementById('loadMoreBtn');
        if (!btn) return;
        btn.style.display = hasMoreReviews ? 'inline-block' : 'none';
        btn.innerHTML = isLoading ? '<i class="fas fa-spinner fa-spin"></i> Loading...' : '<i class="fas fa-sync-alt me-2"></i>Load More Reviews';
    }

    function createLoadMoreButton() {
        const container = document.getElementById('reviewsContainer');
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'text-center mt-3';
        div.innerHTML = `<button id="loadMoreBtn" class="btn btn-outline-warning btn-sm px-4">Load More</button>`;
        container.after(div);
        document.getElementById('loadMoreBtn').onclick = () => loadReviews(currentPage + 1, true);
    }

    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Star Rating Logic
    function setupStarRating() {
        const stars = document.querySelectorAll('.rating-input .stars i');
        stars.forEach(star => {
            star.onclick = function() {
                const val = this.getAttribute('data-value');
                document.getElementById('reviewRating').value = val;
                stars.forEach(s => s.classList.toggle('fas', s.getAttribute('data-value') <= val));
                stars.forEach(s => s.classList.toggle('far', s.getAttribute('data-value') > val));
            };
        });
    }

    // Booking Logic
    function initBookingForm() {
        const dateInput = document.querySelector('input[type="date"]');
        if (dateInput) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.min = new Date().toISOString().split('T')[0];
            dateInput.value = tomorrow.toISOString().split('T')[0];
        }
    }

    function setupReviewForm() {
        const form = document.getElementById('reviewForm');
        if (!form) return;
        if (userSubmittedReview) disableReviewForm();

        form.onsubmit = function(e) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            
            const name = document.getElementById('reviewName').value;
            const rating = document.getElementById('reviewRating').value;
            const review = document.getElementById('reviewText').value;

            const url = `${GOOGLE_SCRIPT_URL}?name=${encodeURIComponent(name)}&rating=${rating}&review=${encodeURIComponent(review)}&t=${Date.now()}`;
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        localStorage.setItem('userSubmittedReview', 'true');
                        disableReviewForm();
                        loadReviews(1, false); // Refresh
                    }
                })
                .finally(() => { submitBtn.disabled = false; });
        };
    }

    function disableReviewForm() {
        const container = document.getElementById('reviewForm').closest('.card');
        if (container) container.innerHTML = `<div class="card-body text-center p-5"><i class="fas fa-check-circle text-success fa-3x mb-3"></i><h4>Thank you!</h4><p>Your review has been submitted.</p></div>`;
    }

    function showNoReviews() {
        const container = document.getElementById('reviewsContainer');
        container.innerHTML = `<div class="text-center p-5"><h6>No reviews yet. Be the first!</h6></div>`;
    }
});
