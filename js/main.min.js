document.addEventListener('DOMContentLoaded', function() {
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxctOKq2qzVL4KalqUnSB_YfLtGmAAK4APdvK2kxYj5trPwikpT808EyYfUymfUUGI/exec';

    // 1. Initial Load
    loadReviews();
    setupReviewForm();
    setupStarRating();

    // 2. Load Reviews from Sheet
    async function loadReviews() {
        const container = document.getElementById('reviewsContainer');
        if (!container) return;

        console.log('ðŸ“¥ Fetching reviews from Google Sheets...');
        
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json();

            if (data.success && data.reviews && data.reviews.length > 0) {
                displayReviews(data.reviews);
            } else {
                showNoReviews();
            }
        } catch (error) {
            console.error('âŒ Load error:', error);
            showNoReviews();
        }
    }

    // 3. Setup Submission Form
    function setupReviewForm() {
        const form = document.getElementById('reviewForm');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Sending...';

            const params = new URLSearchParams({
                name: document.getElementById('reviewName').value,
                rating: document.getElementById('reviewRating').value,
                review: document.getElementById('reviewText').value,
                email: document.getElementById('reviewEmail').value
            });

            try {
                // We use 'no-cors' for submission to ensure it fires even if redirect fails
                await fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`, { 
                    method: 'GET', 
                    mode: 'no-cors' 
                });

                showSuccessMessage();
                form.reset();
                setStarRating(5);
                
                // Refresh list from server after 2 seconds
                setTimeout(loadReviews, 2000);

            } catch (error) {
                console.error('âŒ Submit error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Review';
            }
        });
    }

    // 4. Display Logic
    function displayReviews(reviews) {
        const container = document.getElementById('reviewsContainer');
        container.innerHTML = reviews.map((rev, i) => createReviewCard(rev, i)).join('');
    }

    function createReviewCard(review, index) {
        const name = review.name || 'Guest';
        const initials = (name.match(/\b\w/g) || []).join('').toUpperCase().substring(0, 2) || 'G';
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<i class="${i <= review.rating ? 'fas' : 'far'} fa-star text-warning"></i>`;
        }

        return `
            <div class="col-md-4 mb-4" data-aos="fade-up" data-aos-delay="${(index % 3) * 100}">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-3" style="width:50px; height:50px;">
                                <span class="fw-bold">${initials}</span>
                            </div>
                            <div>
                                <h5 class="mb-0">${name}</h5>
                                <div class="small">${stars}</div>
                            </div>
                        </div>
                        <p class="card-text">"${review.review}"</p>
                        <small class="text-muted">${review.date}</small>
                    </div>
                </div>
            </div>`;
    }

    function showNoReviews() {
        const container = document.getElementById('reviewsContainer');
        if (container) container.innerHTML = '<div class="col-12 text-center text-muted"><p>No reviews found.</p></div>';
    }

    function showSuccessMessage() {
        alert('Thank you! Your review has been submitted.');
    }

    // 5. Star Rating Helper
    function setupStarRating() {
        const stars = document.querySelectorAll('.rating-input .stars i');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                setStarRating(this.getAttribute('data-value'));
            });
        });
    }

    function setStarRating(rating) {
        document.getElementById('reviewRating').value = rating;
        const stars = document.querySelectorAll('.rating-input .stars i');
        stars.forEach((s, i) => {
            s.classList.toggle('fas', i < rating);
            s.classList.toggle('far', i >= rating);
        });
    }
});
